# This Makefile allows running visitors as a preprocessor,
# so as to inspect the generated code and possibly include
# it in a TeX document.

# This assumes the visitors package is installed.

# The rewriting command.
PPX          := `ocamlfind query ppx_deriving`/ppx_deriving \
                `ocamlfind query visitors`/ppx_deriving_visitors.cma
REWRITE      := ocamlfind ppx_tools/rewriter -ppx '$(PPX)'

# Use GNU sed to extract the generated code.
# This requires GNU sed 3.95 or above, I am told.
SED          := $(shell if command -v gsed >/dev/null ; then echo gsed ; else echo sed ; fi)
EXTRACT      := $(SED) -e '/VISITORS.BEGIN/,/VISITORS.END/!d;//d'

# Fix some deficiencies of OCaml's code printer.
# 0. Force a space after a comma.
# 1. Replace multiple consecutive spaces with a single space.
#    This destroys indentation; we restore it afterwards.
# 2. Force a line break after [in], unless there is one already.
# 3. Force a line break after [| ... ->] on a line by itself, unless there is one already.
# 4. Force a line break after [method ... =], unless there is one already.
# 5. Remove the line break between [=] and [object].
BEAUTIFY     := \
              | $(SED) -e 's/,/, /g' \
              | $(SED) -e 's/  / /g' \
              | $(SED) -e 's/ in / in\n/g' \
              | $(SED) -e 's/^\( *|.* ->\) /\1\n/g' \
              | $(SED) -e 's/\(method[^=]*=\) /\1\n/g' \
              | perl -0777 -pe 's/=\n *object/= object/gs' \

# Use ocp-indent to beautify the generated code.
INDENT       := ocp-indent --config=JaneStreet,match_clause=4

%.processed.ml: %.ml
	$(REWRITE) $< | $(EXTRACT) $(BEAUTIFY) | $(INDENT) > $@
